<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css' rel='stylesheet' />
	
<style>
		html,
		body {
			height: 100%;
			width: 100%;
		}
		body {
			margin: 0;
		}
		#map {
			width: 100%;
			height: 100%;
		}
		svg {
			position: relative;
		}
		path {
			fill: yellow;
			stroke-width: 2px;
			stroke: red;
			stroke-opacity: 1;
		}
		.travelMarker {
			fill: yellow;
			opacity: 0.75;
		}
		.waypoints {
			fill: black;
			opacity: 0;
		}
		
		
		.areaChart {
			position: absolute;
			bottom: 0;
			background: #000;
			opacity: 0.5;
		}
		
		.axis path,
		.axis line {
			fill: none;
			stroke: #FFF;
			shape-rendering: crispEdges;
			stroke-width:1;
		}
		
		.axis text {
			stroke: white;
		}

	.lineConnect {
		fill: none;
		stroke: blue;
		opacity: 1;
	}
	.locnames {
		fill: black;
		text-shadow: 1px 1px 1px #FFF, 3px 3px 5px #000;
		font-weight: bold;
		font-size: 13px;
	}
    </style>
</head>
<body>
	<div id="demo"></div>
	<div id="map"></div>
		<script type="text/javascript">
		
			var mapboxTiles = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png?access_token={token}', {
       			attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>',
       			token: 'pk.eyJ1IjoiZHJld3N0aWxlcyIsImEiOiJjaWw2YXR4eXgwMWl6dWhsdjhrZGxuMXBqIn0.4rYaU8tPJ9Mw2bniPfAKdQ'
    		});
     
			var map = L.map('map')
				.addLayer(mapboxTiles)
				.setView([33.77642, -118.11548], 15);
							
			var svg = d3.select(map.getPanes().overlayPane).append("svg");
			var g = svg.append("g").attr("class", "leaflet-zoom-hide");
			
			
			/*
			 * Chart
			 */
			 
			 var margin = { top: 20, right: 20, bottom: 30, left: 50 };
			 var areaChartWidth = window.innerWidth;
			 var areaChartHeight = 200;
			 
			 var x = d3.scale.linear()
			 	.range([0, areaChartWidth]);
			 	
			 var y = d3.scale.linear()
			 	.range([areaChartHeight, 0]);
			 	
			 var xAxis = d3.svg.axis()
			 	.scale(x)
			 	.orient("bottom");
			 	
			var yAxis = d3.svg.axis()
				.scale(y)
				.orient("left");
				
			var area = d3.svg.area()
				.x(function(d) {return x(d.time); })
				.y0(areaChartHeight)
				.y1(function(d) { return y(d.heart); });
				
			var areaChartSvg = d3.select("body").append("svg")
				.attr("width", areaChartWidth + margin.left + margin.right)
				.attr("height", areaChartHeight + margin.top + margin.bottom)
				.attr("class", "areaChart")
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				var dummyData = [];
				
				x.domain([0, 20]);
				y.domain([40, 220]);
				
				var chartPath = areaChartSvg.append("path")
					.datum(dummyData)
					.attr("class", "area");
					
				areaChartSvg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + areaChartHeight + ")")
					.call(xAxis);
					
				areaChartSvg.append("g")
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")
					.attr("transform", "rotate(-90)")
					.attr("y", 6)
					.attr("dy", "0.71em")
					.style("text-anchor", "end")
					.text("Heart Rate (BPM)");
					
					
			d3.json("out.json", function(collection) {
				
				var featuresdata = collection.features;
				mapCoordinatesToView(featuresdata);
				console.log(featuresdata);
				
				var transform = d3.geo.transform({ point: projectPoint });
				var d3path = d3.geo.path().projection(transform);
				
				
				var toLine = d3.svg.line()
					.interpolate("linear")
					.x(function(d) {
						return applyLatLngToLayer(d).x
					})
					.y(function(d) {
						return applyLatLngToLayer(d).y
					});
					
				var ptFeatures = g.selectAll("circle")
					.data(featuresdata)
					.enter()
					.append("circle")
					.attr("r", 3)
					.attr("class", function(d) {
						return "waypoints " + "c" + d.properties.time
					})
					.style("opacity", 1);
				
				var linePath = g.selectAll(".lineConnect")
					.data([featuresdata])
					.enter()
					.append("path")
					.attr("class", "lineConnect");
			
				var marker = g.append("circle")
					.attr("r", 10)
					.attr("id", "marker")
					.attr("class", "travelMarker");
			
			map.on("viewreset", reset);
			
			reset();
			
			transition();
			
			function reset() {
				var bounds = d3path.bounds(collection),
					topLeft = bounds[0],
					bottomRight = bounds[1];
					
				ptFeatures.attr("transform",
					function(d) {
						return "translate(" + 
							applyLatLngToLayer(d).x + "," +
							applyLatLngToLayer(d).y + ")";
					});
					
				marker.attr("transform",
					function() {
						var y = featuresdata[0].geometry.coordinates[1];
						var x = featuresdata[0].geometry.coordinates[0];
						return "translate(" + 
							map.latLngToLayerPoint(new L.LatLng(y, x)).x + "," + 
							map.latLngToLayerPoint(new L.LatLng(y, x)).y + ")";
				})
			
				svg.attr("width", bottomRight[0] - topLeft[0] + 120)
					.attr("height", bottomRight[1] - topLeft[1] + 120)
					.style("left", topLeft[0] - 50 + "px")
					.style("top", topLeft[1] - 50 + "px");
				
				linePath.attr("d", toLine);
				g.attr("transform", "translate(" + (-topLeft[0] + 50) + ","
					+ (-topLeft[1] + 50) + ")");
				}
				
				
				function transition(path) {
					linePath.transition()
						.duration(7500)
						.attrTween("stroke-dasharray", tweenDash)
						.each("end", function() {
						
						})
				}
				
				function tweenDash() {
					return function(t) {
						
						// Total length of path.
						var l = linePath.node().getTotalLength();
						interpolate = d3.interpolateString("0," + l, l + "," + l);
						
						var marker = d3.select("#marker");
						
						// p is the point on the line (coordinates) at a given length along the line.
						// If l = 50 and state currently midway through time interval p would be 25.
						var p = linePath.node().getPointAtLength(t * l);
						
						// Move the marker to that point.
						marker.attr("transform", "translate(" + p.x + "," + p.y + ")");
						
 						getPoint(p.x, p.y);
						
						return interpolate(t);
					}
				}
				
				function projectPoint(x, y)	{
					var point = map.latLngToLayerPoint(new L.LatLng(y, x));
					this.stream.point(point.x, point.y);
				}
				
				function getPoint(x, y) {
					
					for (var i = 0; i < featuresdata.length; i++) {
						
						var dp = featuresdata[i].properties;
						if (Math.abs(dp.x - x) <= 3 && Math.abs(dp.y - y) <= 3) {
							dummyData.push({
								"time": i++,
								"heart": Math.floor(Math.random() * (220 - 40)) + 40
							});
						}
						
						chartPath.attr("d", area);
					}
					
					return oldTime;
				}
				
				var oldTime = null;
				var i = 0;
			});
			
			
			function mapCoordinatesToView(data) {
				for (var i = 0; i < data.length; i++) {
					var coordinates = applyLatLngToLayer(data[i]);
					
					data[i].properties.x = coordinates.x;
					data[i].properties.y = coordinates.y;
				}
			}
			
			
			function applyLatLngToLayer(d) {
				var y = d.geometry.coordinates[1]
				var x = d.geometry.coordinates[0];
				return map.latLngToLayerPoint(new L.LatLng(y, x))
			}
    	</script>
</body>
</html>